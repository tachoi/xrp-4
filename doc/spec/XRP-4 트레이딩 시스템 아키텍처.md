 🏗️ XRP-4 트레이딩 시스템 아키텍처

  1. 전체 파이프라인 흐름

  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                           XRP-4 Trading Pipeline                            │
  └─────────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐     ┌─────────┐     ┌──────────────┐     ┌─────────┐     ┌──────────────┐     ┌───────────┐
    │ TimescaleDB│ → │ Features│ → │     HMM      │ → │ConfirmLayer│ → │    FSM       │ → │DecisionEngine│ → 실행
    │   (OHLCV)  │   │ Builder │   │ (Raw Regime) │   │(Confirmed) │   │(Candidate)   │   │  (Final)     │
    └──────────┘     └─────────┘     └──────────────┘     └─────────┘     └──────────────┘     └───────────┘
         ↓               ↓                ↓                   ↓                ↓                   ↓
      3m/15m          기술적         5개 레짐           레짐 확정        후보 신호           최종 결정
       캔들           지표          분류              + 필터링          생성               + 사이징

  ---
  2. 핵심 컴포넌트 상세

  📊 2.1 데이터 레이어

  ┌─────────────────────────────────────────┐
  │           TimescaleDB                   │
  ├─────────────────────────────────────────┤
  │ • 테이블: ohlcv                         │
  │ • 컬럼: time, open, high, low, close,   │
  │         volume, symbol, timeframe       │
  │ • 타임프레임: 3m (진입), 15m (컨텍스트) │
  └─────────────────────────────────────────┘

  📈 2.2 Feature Builder
  ┌──────────┬────────────────────────────────────────────┬────────────┬─────────────┐
  │ 카테고리 │                    지표                    │ 타임프레임 │    용도     │
  ├──────────┼────────────────────────────────────────────┼────────────┼─────────────┤
  │ 트렌드   │ EMA(20), EMA(50)                           │ 3m         │ 추세 방향   │
  ├──────────┼────────────────────────────────────────────┼────────────┼─────────────┤
  │ 변동성   │ ATR(14), BB Width                          │ 3m/15m     │ 변동성 측정 │
  ├──────────┼────────────────────────────────────────────┼────────────┼─────────────┤
  │ 모멘텀   │ RSI(14), Return                            │ 3m         │ 모멘텀 확인 │
  ├──────────┼────────────────────────────────────────────┼────────────┼─────────────┤
  │ HMM 피처 │ ret, vol, ema_slope, box_range, B_up, B_dn │ 15m        │ 레짐 분류   │
  └──────────┴────────────────────────────────────────────┴────────────┴─────────────┘
  ---
  🧠 2.3 HMM (Hidden Markov Model)

  # 5개 상태 분류
  ┌────────────────────────────────────────────────────────────────┐
  │                    HMM 레짐 분류기                              │
  ├────────────────────────────────────────────────────────────────┤
  │  Input Features (6개):                                         │
  │  • ret: 수익률                                                 │
  │  • vol: 변동성 (20-bar rolling std)                            │
  │  • ema_slope: EMA 기울기                                       │
  │  • box_range: 박스 범위 / ATR                                  │
  │  • B_up: 상방 돌파 강도                                        │
  │  • B_dn: 하방 돌파 강도                                        │
  ├────────────────────────────────────────────────────────────────┤
  │  Output States (5개):                                          │
  │  ┌──────────────┬────────────────────────────────────────┐     │
  │  │ HIGH_VOL     │ 고변동성 (vol_mean 최고)               │     │
  │  │ TREND_UP     │ 상승 추세 (ret_mean 최고)              │     │
  │  │ TREND_DOWN   │ 하락 추세 (ret_mean 최저)              │     │
  │  │ TRANSITION   │ 전환 구간                              │     │
  │  │ RANGE        │ 횡보 구간                              │     │
  │  └──────────────┴────────────────────────────────────────┘     │
  └────────────────────────────────────────────────────────────────┘

  ---
  ✅ 2.4 ConfirmLayer (레짐 확정 레이어)

  ┌────────────────────────────────────────────────────────────────┐
  │                    RegimeConfirmLayer                          │
  ├────────────────────────────────────────────────────────────────┤
  │  Priority 1: HIGH_VOL 처리                                     │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • V >= V_hi_on (base + 1.5×MAD) → HIGH_VOL 활성화        │  │
  │  │ • V < V_hi_off (base + 0.5×MAD) + 안정성 → HIGH_VOL 해제 │  │
  │  │ • Cooldown: 4 bars (60분) 후 재진입 허용                 │  │
  │  └──────────────────────────────────────────────────────────┘  │
  │                                                                │
  │  Priority 2: TRANSITION → TREND 확정                           │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • B_up >= 0.8 ATR + 양의 drift + 양의 slope → TREND_UP   │  │
  │  │ • B_dn >= 0.8 ATR + 음의 drift + 음의 slope → TREND_DOWN │  │
  │  │ • 2봉 연속 확인 필요                                     │  │
  │  └──────────────────────────────────────────────────────────┘  │
  │                                                                │
  │  Priority 3: 기타 레짐 통과                                    │
  │  • RANGE, TREND_UP, TREND_DOWN → 그대로 전달                   │
  ├────────────────────────────────────────────────────────────────┤
  │  Output: ConfirmContext                                        │
  │  • regime_confirmed: 확정된 레짐                               │
  │  • confirm_reason: 확정 사유                                   │
  │  • confirm_metrics: B_up, B_dn, V 등                           │
  └────────────────────────────────────────────────────────────────┘

  ---
  🎯 2.5 TradingFSM (신호 생성기)

  ┌────────────────────────────────────────────────────────────────┐
  │                       TradingFSM                               │
  ├────────────────────────────────────────────────────────────────┤
  │  Input:                                                        │
  │  • MarketContext (price, row_3m, row_15m, zone)                │
  │  • ConfirmContext (regime_confirmed)                           │
  │  • PositionState (side, entry_price, bars_held)                │
  ├────────────────────────────────────────────────────────────────┤
  │  레짐별 신호 생성 규칙:                                        │
  │                                                                │
  │  ┌─────────────┬────────────────────────────────────────────┐  │
  │  │ HIGH_VOL    │ → HOLD (진입 금지)                         │  │
  │  │ NO_TRADE    │ → HOLD (쿨다운)                            │  │
  │  ├─────────────┼────────────────────────────────────────────┤  │
  │  │ RANGE       │ → DISABLED (손실 발생)                     │  │
  │  │             │   - LONG_BOUNCE (지지선 근처)              │  │
  │  │             │   - SHORT_BOUNCE (저항선 근처)             │  │
  │  ├─────────────┼────────────────────────────────────────────┤  │
  │  │ TREND_UP    │ → LONG_TREND_PULLBACK                      │  │
  │  │             │   조건: EMA 정렬 + 기울기 + 리바운드       │  │
  │  ├─────────────┼────────────────────────────────────────────┤  │
  │  │ TREND_DOWN  │ → SHORT_TREND_PULLBACK                     │  │
  │  │             │   조건: EMA 정렬 + 기울기 + 거부 + 연속음봉│  │
  │  │             │         + 피크 확인                        │  │
  │  ├─────────────┼────────────────────────────────────────────┤  │
  │  │ TRANSITION  │ → DISABLED (손실 발생)                     │  │
  │  │             │   - LONG_BREAKOUT                          │  │
  │  │             │   - SHORT_BREAKOUT                         │  │
  │  └─────────────┴────────────────────────────────────────────┘  │
  ├────────────────────────────────────────────────────────────────┤
  │  Output: CandidateSignal                                       │
  │  • signal: HOLD/LONG_TREND_PULLBACK/SHORT_TREND_PULLBACK/EXIT  │
  │  • score: 0~1 신뢰도                                           │
  │  • reason: 신호 생성 사유                                      │
  │  • params: stop_atr_mult, tp_atr_mult 등                       │
  └────────────────────────────────────────────────────────────────┘

  ---
  💼 2.6 DecisionEngine (최종 결정)

  ┌────────────────────────────────────────────────────────────────┐
  │                      DecisionEngine                            │
  ├────────────────────────────────────────────────────────────────┤
  │  Input:                                                        │
  │  • CandidateSignal (FSM 출력)                                  │
  │  • ConfirmContext                                              │
  │  • PositionState                                               │
  ├────────────────────────────────────────────────────────────────┤
  │  정책 적용 순서:                                               │
  │                                                                │
  │  1️⃣ Hard Deny Policy                                           │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • HIGH_VOL 레짐 → 신규 진입 차단 (청산만 허용)           │  │
  │  │ • NO_TRADE 레짐 → 신규 진입 차단                         │  │
  │  └──────────────────────────────────────────────────────────┘  │
  │                                                                │
  │  2️⃣ Cooldown Policy                                            │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • 쿨다운 중 Breakout 차단                                │  │
  │  │ • 쿨다운 중 사이즈 50% 축소                              │  │
  │  └──────────────────────────────────────────────────────────┘  │
  │                                                                │
  │  3️⃣ Size Calculation                                           │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • BASE_SIZE_USDT: $100                                   │  │
  │  │ • TRANSITION: ×0.4                                       │  │
  │  │ • COOLDOWN: ×0.5                                         │  │
  │  │ • Score 기반: ×(0.5 + score×0.5)                         │  │
  │  └──────────────────────────────────────────────────────────┘  │
  │                                                                │
  │  4️⃣ Signal → Action 변환                                       │
  │  ┌──────────────────────────────────────────────────────────┐  │
  │  │ • LONG_* → OPEN_LONG (FLAT) / CLOSE (SHORT 청산)         │  │
  │  │ • SHORT_* → OPEN_SHORT (FLAT) / CLOSE (LONG 청산)        │  │
  │  │ • EXIT → CLOSE                                           │  │
  │  │ • HOLD → NO_ACTION                                       │  │
  │  └──────────────────────────────────────────────────────────┘  │
  ├────────────────────────────────────────────────────────────────┤
  │  Output: Decision                                              │
  │  • action: NO_ACTION/OPEN_LONG/OPEN_SHORT/CLOSE                │
  │  • size: 포지션 크기 (USDT)                                    │
  │  • reason: 결정 사유                                           │
  └────────────────────────────────────────────────────────────────┘

  ---
  3. 데이터 흐름 예시

  시간: 2024-07-15 14:30:00 (3m bar)

  1️⃣ 데이터 수집
     └─ 3m: close=0.55, ema_20=0.548, ema_50=0.545, atr=0.008, ret=+0.002
     └─ 15m: ema_slope=+0.003, vol=0.015, B_up=0.2

  2️⃣ HMM 예측
     └─ Input: [ret, vol, ema_slope, box_range, B_up, B_dn]
     └─ Output: state=3 (TREND_UP)

  3️⃣ ConfirmLayer
     └─ regime_raw: TREND_UP
     └─ regime_confirmed: TREND_UP (PASSTHROUGH)

  4️⃣ FSM
     └─ Regime: TREND_UP
     └─ 조건 체크:
        ├─ EMA 정렬: fast(0.548) > slow(0.545) ✓
        ├─ 기울기: 0.003 >= 0.002 ✓
        ├─ 풀백: price(0.55) <= threshold(0.564) ✓
        └─ 리바운드: ret(+0.002) >= 0.0003 ✓
     └─ Output: LONG_TREND_PULLBACK, score=0.65

  5️⃣ DecisionEngine
     └─ 정책 체크:
        ├─ Hard Deny: PASS (not HIGH_VOL)
        └─ Cooldown: PASS
     └─ 사이즈: $100 × 0.825 = $82.5
     └─ Output: OPEN_LONG, size=$82.5

  6️⃣ 실행
     └─ LONG 포지션 진입 @ 0.55, size=$82.5

  ---
  4. 파일 구조

  xrp-4/
  ├── src/xrp4/
  │   ├── core/                      # 핵심 로직
  │   │   ├── types.py               # 데이터 타입 정의
  │   │   ├── fsm.py                 # TradingFSM (신호 생성)
  │   │   └── decision_engine.py     # DecisionEngine (최종 결정)
  │   │
  │   ├── regime/                    # 레짐 관련
  │   │   ├── confirm.py             # ConfirmLayer
  │   │   └── hmm_*.py               # HMM 모델들
  │   │
  │   ├── features/                  # 피처 생성
  │   │   ├── indicators.py          # 기술적 지표
  │   │   └── hmm_features.py        # HMM 입력 피처
  │   │
  │   └── zones/                     # 지지/저항 영역
  │       └── zone_builder.py
  │
  ├── scripts/                       # 실행 스크립트
  │   ├── backtest_fsm_pipeline.py   # 백테스트
  │   ├── tune_short_params.py       # SHORT 파라미터 튜닝
  │   └── train_simple_hmm.py        # HMM 학습
  │
  ├── models/                        # 저장된 모델
  │   └── hmm_simple.pkl             # 학습된 HMM
  │
  └── outputs/                       # 결과 저장
      └── fsm_backtest/
          ├── trades_test.csv
          └── fsm_backtest_results.json

  ---
  5. 현재 설정 요약
  ┌──────────┬───────────────────────────┬───────┬───────────┐
  │ 컴포넌트 │         파라미터          │  값   │   상태    │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ HMM      │ n_states                  │ 5     │ -         │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ FSM      │ RANGE_ENABLED             │ False │ 🚫 비활성 │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ FSM      │ TRANSITION_ALLOW_BREAKOUT │ False │ 🚫 비활성 │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ FSM      │ SHORT_ENABLED             │ True  │ ✅ 활성   │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ FSM      │ SHORT_CONSEC_NEG_BARS     │ 1     │ 튜닝됨    │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ FSM      │ SHORT_PEAK_CONFIRM_BARS   │ 2     │ 튜닝됨    │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ DE       │ BASE_SIZE_USDT            │ $100  │ -         │
  ├──────────┼───────────────────────────┼───────┼───────────┤
  │ DE       │ DENY_IN_HIGH_VOL          │ True  │ -         │
  └──────────┴───────────────────────────┴───────┴───────────┘
  ---
  6. 활성화된 전략 요약
  ┌────────────┬──────────────────────┬───────┬───────────────────┐
  │    레짐    │         신호         │ 방향  │       상태        │
  ├────────────┼──────────────────────┼───────┼───────────────────┤
  │ TREND_UP   │ LONG_TREND_PULLBACK  │ LONG  │ ✅ 활성 (+$16.98) │
  ├────────────┼──────────────────────┼───────┼───────────────────┤
  │ TREND_DOWN │ SHORT_TREND_PULLBACK │ SHORT │ ✅ 활성 (+$4.26)  │
  ├────────────┼──────────────────────┼───────┼───────────────────┤
  │ RANGE      │ LONG/SHORT_BOUNCE    │ -     │ 🚫 비활성         │
  ├────────────┼──────────────────────┼───────┼───────────────────┤
  │ TRANSITION │ LONG/SHORT_BREAKOUT  │ -     │ 🚫 비활성         │
  ├────────────┼──────────────────────┼───────┼───────────────────┤
  │ HIGH_VOL   │ -                    │ -     │ 🚫 거래 차단      │
  └────────────┴──────────────────────┴───────┴───────────────────┘